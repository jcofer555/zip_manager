Menu="Utilities"
Type="xmenu"
Title="7z Extractor"
Icon="unzip.png"
Tag="unzip.png"
Markdown="false"
---

<style>
.field-row {
  display: flex;
  align-items: center;
  margin-bottom: 12px;
}

.field-row label {
  width: 160px;
  font-weight: bold;
  color: orange;
}

.field-row input {
  max-width: 300px;
  flex: 1;
  padding: 6px;
  border-radius: 4px;
  background-color: #1d1d1d;
  color: orange;
  cursor: pointer;
}
</style>

<div>
  <h2 style="color: white;">ğŸ“¦ Zip Manager</h2>

  <div class="field-row">
    <label for="inputFile">Archive File:</label>
    <input type="text" id="inputFile" placeholder="Click to browse" readonly onclick="openPicker('inputFile', false)" />
  </div>

  <div class="field-row">
    <label for="outputDir">Output Directory:</label>
    <input type="text" id="outputDir" placeholder="Click to browse" readonly onclick="openPicker('outputDir', true)" />
  </div>

  <button onclick="runExtraction()">ğŸš€ Extract</button>
  <br/><br/>
  <div id="statusBox">Status will appear here...</div>
</div>

  <!-- Modal Picker -->
  <div id="pickerModal" style="display:none; background:#fafafa; border:1px solid #ccc; padding:15px; z-index:1000; box-shadow:0 4px 8px rgba(0,0,0,0.1);">
    <ul id="fileList" style="list-style:none; padding:0;"></ul>
    <button onclick="closeModal()">âŒ Close</button>
  </div>
</div>

<script>
// ğŸ§  Picker modal logic using live Unraid filesystem
function openPicker(targetId, isDir) {
  const root = "/mnt/user/";
  const endpoint = `/plugins/zip_manager/list_files.php?dir=${encodeURIComponent(root)}`;

  fetch(endpoint)
    .then(res => res.json())
    .then(items => {
      if (items.error) {
        document.getElementById("statusBox").innerText = "âŒ " + items.error;
        return;
      }

      const filtered = items.filter(name =>
        isDir ? name.endsWith("/") : /\.(zip|7z|rar)$/i.test(name)
      );

      const ul = document.getElementById("fileList");
      ul.innerHTML = "";

      filtered.forEach(name => {
        const li = document.createElement("li");
        li.textContent = name;
        li.style.cursor = "pointer";
        li.style.color = 'orange';
        li.onmouseenter = () => li.style.textDecoration = 'underline';
        li.onmouseleave = () => li.style.textDecoration = 'none';
        li.onclick = () => {
          document.getElementById(targetId).value = root + name;
          closeModal();
        };
        ul.appendChild(li);
      });

      document.getElementById("pickerModal").style.display = "block";
    });
}

function closeModal() {
  document.getElementById("pickerModal").style.display = "none";
}

function runExtraction() {
  const input = document.getElementById("inputFile").value;
  const output = document.getElementById("outputDir").value;

  if (!input || !output) {
    document.getElementById("statusBox").innerText = "âŒ Please select both input and output.";
    return;
  }

  const endpoint = `/plugins/zip_manager/extract.sh?input=${encodeURIComponent(input)}&output=${encodeURIComponent(output)}`;
  fetch(endpoint)
    .then(res => res.text())
    .then(msg => {
      document.getElementById("statusBox").innerText = msg;
    });
}
</script>
